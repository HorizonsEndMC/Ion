version: "3.9"

services:
  redis:
    container_name: "redis"
    image: redis

  mongo:
    image: "mongo:4.2"
    container_name: "mongo"
    command: [ "--replSet", "rs0" ]
    ports: [ 127.0.0.1:27017:27017 ]
    volumes:
      - ./config/mongo/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
      - ./db:/data/db:rw
    healthcheck:
      test: "test $$(echo 'rs.initiate().ok' | mongo -u $${MONGO_INITDB_ROOT_USERNAME} -p $${MONGO_INITDB_ROOT_PASSWORD} --host mongo) -eq 1"
      interval: 1s
      start_period: 1s
    environment:
      MONGO_INITDB_ROOT_USERNAME: "test"
      MONGO_INITDB_ROOT_PASSWORD: "test"
      MONGO_INITDB_DATABASE: "test"
      MONGO_REPLICA_SET_NAME: rs0

  waterfall:
    image: "itzg/bungeecord"
    container_name: "waterfall"
    ports: [ 25565:25577 ]
    tty: true
    stdin_open: true
    volumes:
      - ./waterfall:/server
      - ../build/IonProxy.jar:/server/plugins/Ion.jar
      - ./config/waterfall/config.yml:/server/config.yml
    environment:
      TYPE: "VELOCITY"
      JVM_XX_OPTS: "-XX:+UseG1GC -XX:G1HeapRegionSize=4M -XX:+UnlockExperimentalVMOptions -XX:+ParallelRefProcEnabled -XX:+AlwaysPreTouch"

  paper:
    image: "itzg/minecraft-server"
    container_name: "paper"
    ports:
      - "5005:5005"
      - "8123:8123"
    tty: true
    stdin_open: true
    volumes:
      - ./paper:/data
      - ../build/IonServer.jar:/plugins/Ion.jar
      - ./config/paper:/config
    environment:
      TYPE: "PAPER"
      VERSION: "1.19.4"
      EULA: "TRUE"
      USE_AIKAR_FLAGS: "TRUE"
      COPY_CONFIG_DEST: "/data"
      SYNC_SKIP_NEWER_IN_DESTINATION: "FALSE"
      JVM_OPTS: "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"
